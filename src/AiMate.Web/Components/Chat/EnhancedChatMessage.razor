@using AiMate.Core.Entities
@using AiMate.Core.Enums
@using AiMate.Web.Services
@inject IJSRuntime JSRuntime
@inject MarkdownService MarkdownService

<div class="@GetMessageContainerClass() group" @ref="messageElement">
    @* Avatar *@
    <div class="flex-shrink-0">
        @if (Message.Role == MessageRole.Assistant)
        {
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center shadow-lg">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09Z"/>
                </svg>
            </div>
        }
        else
        {
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-emerald-500 to-teal-500 flex items-center justify-center shadow-lg text-white font-semibold text-sm">
                @GetUserInitials()
            </div>
        }
    </div>

    @* Message Content *@
    <div class="flex-1 min-w-0">
        @if (isEditing)
        {
            @* Edit Mode *@
            <div class="space-y-3">
                <textarea @bind="editedContent"
                          @bind:event="oninput"
                          class="w-full p-4 bg-[#1A1A1A] border border-[#2A2A2A] rounded-xl text-white resize-none focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all font-mono text-sm"
                          rows="6"
                          placeholder="Edit your message..."></textarea>
                <div class="flex items-center gap-2">
                    <button @onclick="HandleSaveEdit"
                            disabled="@string.IsNullOrWhiteSpace(editedContent)"
                            class="px-5 py-2.5 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white rounded-lg text-sm font-medium transition-all shadow-lg hover:shadow-purple-500/50">
                        Save Changes
                    </button>
                    <button @onclick="HandleCancelEdit"
                            class="px-5 py-2.5 bg-[#242424] hover:bg-[#2A2A2A] text-gray-300 rounded-lg text-sm font-medium transition-all">
                        Cancel
                    </button>
                </div>
            </div>
        }
        else
        {
            @* Display Mode *@
            <div class="space-y-2">
                @* Timestamp and Metadata *@
                <div class="flex items-center gap-3 text-xs text-gray-500">
                    <span class="font-medium">@(Message.Role == MessageRole.Assistant ? "AI Assistant" : UserName ?? "You")</span>
                    <span>•</span>
                    <span title="@Message.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")">
                        @FormatTimestamp(Message.CreatedAt)
                    </span>
                    @if (Message.TokensUsed.HasValue)
                    {
                        <span>•</span>
                        <span class="flex items-center gap-1" title="Tokens used">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M12 1v6m0 6v6m0-18a11 11 0 0 1 0 22 11 11 0 0 1 0-22"/>
                            </svg>
                            @Message.TokensUsed.Value.ToString("N0")
                        </span>
                    }
                    @if (Message.Cost.HasValue)
                    {
                        <span>•</span>
                        <span class="text-emerald-500" title="Cost in NZD">
                            $@Message.Cost.Value.ToString("0.0000")
                        </span>
                    }
                </div>

                @* Message Content *@
                <div class="@GetMessageContentClass()">
                    @if (Message.IsStreaming)
                    {
                        @* Streaming Indicator *@
                        <div class="flex items-start gap-3">
                            <div class="flex-1 prose prose-invert max-w-none">
                                @((MarkupString)MarkdownService.ToHtml(Message.Content))
                            </div>
                            <div class="flex-shrink-0">
                                <div class="flex gap-1">
                                    <div class="w-1.5 h-1.5 bg-purple-500 rounded-full animate-pulse" style="animation-delay: 0ms"></div>
                                    <div class="w-1.5 h-1.5 bg-purple-500 rounded-full animate-pulse" style="animation-delay: 150ms"></div>
                                    <div class="w-1.5 h-1.5 bg-purple-500 rounded-full animate-pulse" style="animation-delay: 300ms"></div>
                                </div>
                            </div>
                        </div>
                    }
                    else if (Message.Role == MessageRole.User)
                    {
                        <div class="text-gray-100 whitespace-pre-wrap leading-relaxed">@Message.Content</div>
                    }
                    else
                    {
                        @* AI Message with Markdown *@
                        <div class="prose prose-invert prose-sm max-w-none">
                            @((MarkupString)MarkdownService.ToHtml(Message.Content))
                        </div>
                    }
                </div>

                @* Tool Calls *@
                @if (Message.ToolCalls?.Any() == true)
                {
                    <div class="mt-4 space-y-2">
                        @foreach (var toolCall in Message.ToolCalls)
                        {
                            <ToolCallDisplay ToolCall="toolCall" />
                        }
                    </div>
                }

                @* Message Actions *@
                <div class="flex items-center gap-1 mt-3 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                    @if (Message.Role == MessageRole.Assistant)
                    {
                        <button @onclick="HandleCopy"
                                class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs text-gray-400 hover:text-white hover:bg-[#2A2A2A] rounded-lg transition-all"
                                title="Copy message">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </svg>
                            <span>Copy</span>
                        </button>

                        <button @onclick="HandleShare"
                                class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs text-gray-400 hover:text-white hover:bg-[#2A2A2A] rounded-lg transition-all"
                                title="Share message">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <circle cx="18" cy="5" r="3"/>
                                <circle cx="6" cy="12" r="3"/>
                                <circle cx="18" cy="19" r="3"/>
                                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                            </svg>
                            <span>Share</span>
                        </button>

                        <button @onclick="HandleReadAloud"
                                class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs text-gray-400 hover:text-white hover:bg-[#2A2A2A] rounded-lg transition-all"
                                title="Read aloud">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M11 5L6 9H2v6h4l5 4V5z"/>
                                <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
                            </svg>
                            <span>Read</span>
                        </button>

                        @if (OnRegenerate.HasDelegate)
                        {
                            <button @onclick="OnRegenerate"
                                    class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs text-gray-400 hover:text-white hover:bg-[#2A2A2A] rounded-lg transition-all"
                                    title="Regenerate response">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                                    <path d="M3 3v5h5"/>
                                    <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/>
                                    <path d="M16 21h5v-5"/>
                                </svg>
                                <span>Regenerate</span>
                            </button>
                        }

                        <div class="flex-1"></div>

                        <button @onclick="() => HandleFeedback(true)"
                                class="p-1.5 @(Message.Rating > 0 ? "text-green-400" : "text-gray-400") hover:text-green-400 hover:bg-[#2A2A2A] rounded-lg transition-all"
                                title="Good response">
                            <svg class="w-4 h-4" fill="@(Message.Rating > 0 ? "currentColor" : "none")" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/>
                            </svg>
                        </button>

                        <button @onclick="() => HandleFeedback(false)"
                                class="p-1.5 @(Message.Rating < 0 ? "text-red-400" : "text-gray-400") hover:text-red-400 hover:bg-[#2A2A2A] rounded-lg transition-all"
                                title="Bad response">
                            <svg class="w-4 h-4" fill="@(Message.Rating < 0 ? "currentColor" : "none")" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"/>
                            </svg>
                        </button>
                    }
                    else
                    {
                        <button @onclick="HandleStartEdit"
                                class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs text-gray-400 hover:text-white hover:bg-[#2A2A2A] rounded-lg transition-all"
                                title="Edit message">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
                            </svg>
                            <span>Edit</span>
                        </button>

                        <button @onclick="HandleDelete"
                                class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs text-gray-400 hover:text-red-400 hover:bg-[#2A2A2A] rounded-lg transition-all"
                                title="Delete message">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                            <span>Delete</span>
                        </button>
                    }

                    <button @onclick="HandleOpenKebabMenu"
                            class="p-1.5 text-gray-400 hover:text-white hover:bg-[#2A2A2A] rounded-lg transition-all"
                            title="More options">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <circle cx="12" cy="5" r="2"/>
                            <circle cx="12" cy="12" r="2"/>
                            <circle cx="12" cy="19" r="2"/>
                        </svg>
                    </button>
                </div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public required Message Message { get; set; }
    [Parameter] public string? UserName { get; set; }
    [Parameter] public EventCallback<string> OnEdit { get; set; }
    [Parameter] public EventCallback OnRegenerate { get; set; }
    [Parameter] public EventCallback OnDelete { get; set; }
    [Parameter] public EventCallback OnShare { get; set; }

    private ElementReference messageElement;
    private bool isEditing = false;
    private string editedContent = string.Empty;

    private string GetMessageContainerClass()
    {
        return Message.Role == MessageRole.User
            ? "flex gap-4 flex-row-reverse mb-6"
            : "flex gap-4 mb-6";
    }

    private string GetMessageContentClass()
    {
        return Message.Role == MessageRole.User
            ? "bg-gradient-to-br from-[#2A2A2A] to-[#242424] rounded-2xl px-5 py-4 shadow-lg"
            : "bg-transparent rounded-2xl px-1 py-2";
    }

    private string GetUserInitials()
    {
        if (!string.IsNullOrWhiteSpace(UserName))
        {
            var parts = UserName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            if (parts.Length >= 2)
                return $"{parts[0][0]}{parts[1][0]}".ToUpper();
            return UserName[0].ToString().ToUpper();
        }
        return "U";
    }

    private string FormatTimestamp(DateTime timestamp)
    {
        var local = timestamp.ToLocalTime();
        var now = DateTime.Now;
        var diff = now - local;

        if (diff.TotalMinutes < 1)
            return "just now";
        if (diff.TotalMinutes < 60)
            return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalHours < 24)
            return $"{(int)diff.TotalHours}h ago";
        if (diff.TotalDays < 7)
            return $"{(int)diff.TotalDays}d ago";

        return local.ToString("MMM dd, yyyy");
    }

    private async Task HandleCopy()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", Message.Content);
            // TODO: Show toast notification
        }
        catch
        {
            // Fallback or error handling
        }
    }

    private async Task HandleShare()
    {
        if (OnShare.HasDelegate)
        {
            await OnShare.InvokeAsync();
        }
    }

    private async Task HandleReadAloud()
    {
        // TODO: Implement text-to-speech
        await Task.CompletedTask;
    }

    private void HandleFeedback(bool positive)
    {
        Message.Rating = positive ? 1 : -1;
        // TODO: Dispatch Fluxor action to save feedback
    }

    private void HandleStartEdit()
    {
        editedContent = Message.Content;
        isEditing = true;
    }

    private async Task HandleSaveEdit()
    {
        if (!string.IsNullOrWhiteSpace(editedContent) && editedContent != Message.Content)
        {
            await OnEdit.InvokeAsync(editedContent);
            isEditing = false;
        }
    }

    private void HandleCancelEdit()
    {
        isEditing = false;
        editedContent = string.Empty;
    }

    private async Task HandleDelete()
    {
        if (OnDelete.HasDelegate)
        {
            await OnDelete.InvokeAsync();
        }
    }

    private void HandleOpenKebabMenu()
    {
        // TODO: Open context menu with more options
    }
}
