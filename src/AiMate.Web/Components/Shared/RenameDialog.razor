@* Reusable rename dialog for chats, knowledge, workspaces, etc. *@

<BaseDialog IsOpen="@IsOpen"
            IsOpenChanged="@IsOpenChanged"
            Title="@Title"
            Size="BaseDialog.DialogSize.Medium"
            ShowCloseButton="true"
            OnClose="@HandleCancel">
    <ChildContent>
        <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">
                @Label
            </label>
            <input type="text"
                   @bind="currentName"
                   @bind:event="oninput"
                   @onkeydown="HandleKeyDown"
                   @ref="inputElement"
                   class="w-full px-3 py-2 bg-[#0F0F0F] border border-[#2A2A2A] rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all"
                   placeholder="@Placeholder"
                   maxlength="@MaxLength"
                   disabled="@IsProcessing">

            @* Character counter *@
            @if (ShowCharacterCount && MaxLength > 0)
            {
                <div class="mt-1 text-xs text-right @CharacterCountClass">
                    @currentName.Length / @MaxLength
                </div>
            }

            @* Validation error *@
            @if (!string.IsNullOrEmpty(validationError))
            {
                <div class="mt-2 flex items-start gap-2 text-red-400 text-sm">
                    <svg class="w-4 h-4 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>@validationError</span>
                </div>
            }

            @* Helper text *@
            @if (!string.IsNullOrEmpty(HelperText) && string.IsNullOrEmpty(validationError))
            {
                <div class="mt-2 text-sm text-gray-400">
                    @HelperText
                </div>
            }
        </div>
    </ChildContent>

    <Actions>
        <button @onclick="HandleCancel"
                disabled="@IsProcessing"
                class="flex-1 px-4 py-2 bg-[#0F0F0F] hover:bg-[#2A2A2A] disabled:opacity-50 disabled:cursor-not-allowed text-gray-300 rounded-lg transition-all">
            Cancel
        </button>
        <button @onclick="HandleSave"
                disabled="@(!CanSave || IsProcessing)"
                class="flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-purple-800 disabled:cursor-not-allowed text-white rounded-lg transition-all font-medium">
            @if (IsProcessing)
            {
                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            }
            @SaveButtonText
        </button>
    </Actions>
</BaseDialog>

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback<bool> IsOpenChanged { get; set; }

    [Parameter] public string Title { get; set; } = "Rename";
    [Parameter] public string Label { get; set; } = "Name";
    [Parameter] public string Placeholder { get; set; } = "Enter a name...";
    [Parameter] public string HelperText { get; set; } = string.Empty;

    [Parameter] public string CurrentValue { get; set; } = string.Empty;
    [Parameter] public int MaxLength { get; set; } = 200;
    [Parameter] public bool ShowCharacterCount { get; set; } = true;
    [Parameter] public string SaveButtonText { get; set; } = "Save";

    [Parameter] public bool IsProcessing { get; set; } = false;
    [Parameter] public Func<string, string?>? CustomValidator { get; set; }

    [Parameter] public EventCallback<string> OnSave { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    private ElementReference inputElement;
    private string currentName = string.Empty;
    private string validationError = string.Empty;

    protected override void OnParametersSet()
    {
        if (IsOpen && currentName != CurrentValue)
        {
            currentName = CurrentValue ?? string.Empty;
            validationError = string.Empty;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (IsOpen)
        {
            try
            {
                // Focus and select all text in the input
                await Task.Delay(100); // Small delay to ensure dialog is rendered
                // Note: In production, you'd use JSInterop to focus and select
                // await JSRuntime.InvokeVoidAsync("focusAndSelect", inputElement);
            }
            catch
            {
                // Ignore focus errors
            }
        }
    }

    private bool CanSave
    {
        get
        {
            if (string.IsNullOrWhiteSpace(currentName))
                return false;

            if (currentName.Trim() == CurrentValue?.Trim())
                return false; // No change

            return string.IsNullOrEmpty(Validate());
        }
    }

    private string CharacterCountClass
    {
        get
        {
            var percentage = MaxLength > 0 ? (double)currentName.Length / MaxLength : 0;
            return percentage switch
            {
                >= 0.9 => "text-red-400",
                >= 0.7 => "text-yellow-400",
                _ => "text-gray-500"
            };
        }
    }

    private string? Validate()
    {
        if (string.IsNullOrWhiteSpace(currentName))
            return "Name is required";

        if (MaxLength > 0 && currentName.Length > MaxLength)
            return $"Name must be {MaxLength} characters or less";

        // Custom validation
        if (CustomValidator != null)
        {
            var customError = CustomValidator(currentName);
            if (!string.IsNullOrEmpty(customError))
                return customError;
        }

        return null;
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && CanSave && !IsProcessing)
        {
            await HandleSave();
        }
        else if (e.Key == "Escape")
        {
            await HandleCancel();
        }
    }

    private async Task HandleSave()
    {
        validationError = Validate() ?? string.Empty;

        if (string.IsNullOrEmpty(validationError))
        {
            if (OnSave.HasDelegate)
            {
                await OnSave.InvokeAsync(currentName.Trim());
            }
            await IsOpenChanged.InvokeAsync(false);
        }
    }

    private async Task HandleCancel()
    {
        currentName = CurrentValue ?? string.Empty;
        validationError = string.Empty;

        if (OnCancel.HasDelegate)
        {
            await OnCancel.InvokeAsync();
        }

        await IsOpenChanged.InvokeAsync(false);
    }
}
