@* Delete confirmation dialog with consequences preview *@

<BaseDialog IsOpen="@IsOpen"
            IsOpenChanged="@IsOpenChanged"
            Title="@Title"
            Size="BaseDialog.DialogSize.Medium"
            ShowCloseButton="true"
            CloseOnBackdropClick="false"
            CloseOnEscape="true"
            OnClose="@HandleCancel">
    <ChildContent>
        @* Warning Icon *@
        <div class="flex justify-center mb-4">
            <div class="w-16 h-16 rounded-full bg-red-500/10 flex items-center justify-center">
                <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
            </div>
        </div>

        @* Main message *@
        <div class="text-center mb-4">
            <p class="text-base text-gray-200">
                @if (!string.IsNullOrEmpty(Message))
                {
                    @Message
                }
                else
                {
                    <text>Are you sure you want to delete <span class="font-semibold text-white">"@ItemName"</span>?</text>
                }
            </p>
        </div>

        @* Item preview *@
        @if (!string.IsNullOrEmpty(ItemName) || ItemPreview != null)
        {
            <div class="mb-4 p-3 bg-[#0F0F0F] border border-[#2A2A2A] rounded-lg">
                @if (ItemPreview != null)
                {
                    @ItemPreview
                }
                else if (!string.IsNullOrEmpty(ItemName))
                {
                    <div class="flex items-center gap-3">
                        <div class="flex-shrink-0">
                            @if (!string.IsNullOrEmpty(ItemIcon))
                            {
                                <span class="text-2xl">@ItemIcon</span>
                            }
                            else
                            {
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                            }
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-white truncate">@ItemName</p>
                            @if (!string.IsNullOrEmpty(ItemDescription))
                            {
                                <p class="text-xs text-gray-400 truncate">@ItemDescription</p>
                            }
                        </div>
                    </div>
                }
            </div>
        }

        @* Consequences *@
        @if (Consequences.Any() || ConsequencesContent != null)
        {
            <div class="mb-4 p-4 bg-red-500/5 border border-red-500/20 rounded-lg">
                <div class="flex items-start gap-2 mb-2">
                    <svg class="w-5 h-5 text-red-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-red-400 mb-2">This action will:</p>
                        @if (ConsequencesContent != null)
                        {
                            @ConsequencesContent
                        }
                        else if (Consequences.Any())
                        {
                            <ul class="space-y-1 text-sm text-gray-300">
                                @foreach (var consequence in Consequences)
                                {
                                    <li class="flex items-start gap-2">
                                        <span class="text-red-400 mt-0.5">â€¢</span>
                                        <span>@consequence</span>
                                    </li>
                                }
                            </ul>
                        }
                    </div>
                </div>
            </div>
        }

        @* Warning message *@
        @if (!string.IsNullOrEmpty(WarningMessage))
        {
            <div class="mb-4 p-3 bg-yellow-500/5 border border-yellow-500/20 rounded-lg">
                <p class="text-sm text-yellow-400">@WarningMessage</p>
            </div>
        }

        @* Confirmation input (type to confirm) *@
        @if (RequireConfirmation)
        {
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-300 mb-2">
                    Type <span class="font-mono font-semibold text-red-400">@ConfirmationText</span> to confirm
                </label>
                <input type="text"
                       @bind="confirmationInput"
                       @bind:event="oninput"
                       @onkeydown="HandleKeyDown"
                       class="w-full px-3 py-2 bg-[#0F0F0F] border @ConfirmationBorderClass rounded-lg text-white font-mono focus:outline-none focus:ring-2 focus:ring-red-500 transition-all"
                       placeholder="@ConfirmationText"
                       disabled="@IsProcessing">
            </div>
        }
    </ChildContent>

    <Actions>
        <button @onclick="HandleCancel"
                disabled="@IsProcessing"
                class="flex-1 px-4 py-2 bg-[#0F0F0F] hover:bg-[#2A2A2A] disabled:opacity-50 disabled:cursor-not-allowed text-gray-300 rounded-lg transition-all">
            Cancel
        </button>
        <button @onclick="HandleDelete"
                disabled="@(!CanDelete || IsProcessing)"
                class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 disabled:bg-red-800 disabled:cursor-not-allowed text-white rounded-lg transition-all font-medium">
            @if (IsProcessing)
            {
                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            }
            @DeleteButtonText
        </button>
    </Actions>
</BaseDialog>

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback<bool> IsOpenChanged { get; set; }

    [Parameter] public string Title { get; set; } = "Delete Item";
    [Parameter] public string Message { get; set; } = string.Empty;

    [Parameter] public string ItemName { get; set; } = string.Empty;
    [Parameter] public string ItemDescription { get; set; } = string.Empty;
    [Parameter] public string ItemIcon { get; set; } = string.Empty;
    [Parameter] public RenderFragment? ItemPreview { get; set; }

    [Parameter] public List<string> Consequences { get; set; } = new();
    [Parameter] public RenderFragment? ConsequencesContent { get; set; }
    [Parameter] public string WarningMessage { get; set; } = string.Empty;

    [Parameter] public bool RequireConfirmation { get; set; } = false;
    [Parameter] public string ConfirmationText { get; set; } = "DELETE";

    [Parameter] public string DeleteButtonText { get; set; } = "Delete";
    [Parameter] public bool IsProcessing { get; set; } = false;

    [Parameter] public EventCallback OnDelete { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    private string confirmationInput = string.Empty;

    protected override void OnParametersSet()
    {
        if (IsOpen && !string.IsNullOrEmpty(confirmationInput))
        {
            confirmationInput = string.Empty;
        }
    }

    private bool CanDelete
    {
        get
        {
            if (!RequireConfirmation)
                return true;

            return confirmationInput.Equals(ConfirmationText, StringComparison.Ordinal);
        }
    }

    private string ConfirmationBorderClass
    {
        get
        {
            if (string.IsNullOrEmpty(confirmationInput))
                return "border-[#2A2A2A]";

            return CanDelete
                ? "border-green-500"
                : "border-red-500";
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && CanDelete && !IsProcessing)
        {
            await HandleDelete();
        }
        else if (e.Key == "Escape")
        {
            await HandleCancel();
        }
    }

    private async Task HandleDelete()
    {
        if (CanDelete)
        {
            if (OnDelete.HasDelegate)
            {
                await OnDelete.InvokeAsync();
            }
            await IsOpenChanged.InvokeAsync(false);
        }
    }

    private async Task HandleCancel()
    {
        confirmationInput = string.Empty;

        if (OnCancel.HasDelegate)
        {
            await OnCancel.InvokeAsync();
        }

        await IsOpenChanged.InvokeAsync(false);
    }
}
