@page "/chat/{conversationId?}"
@using Fluxor
@using AiMate.Web.Store.Chat
@using AiMate.Core.Entities
@using AiMate.Core.Enums
@inherits Fluxor.Blazor.Web.Components.FluxorComponent
@inject IState<ChatState> ChatState
@inject IDispatcher Dispatcher
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<div class="flex flex-col h-full bg-[#0F0F0F]">
    @* Chat Message List *@
    <ChatMessageList Messages="@currentConversation?.Messages"
                     UserName="@GetCurrentUserName()"
                     IsLoading="@isLoading"
                     LoadingText="@GetLoadingText()"
                     ExamplePrompts="@GetExamplePrompts()"
                     OnExampleClick="@HandleExamplePrompt"
                     OnEditMessage="@HandleEditMessage"
                     OnRegenerateMessage="@HandleRegenerateMessage"
                     OnDeleteMessage="@HandleDeleteMessage"
                     OnShareMessage="@HandleShareMessage"
                     UseVirtualization="true"
                     VirtualizationThreshold="50" />

    @* Input Area *@
    <ChatInput OnSend="HandleSendMessage" />
</div>

@code {
    [Parameter] public string? ConversationId { get; set; }

    private Conversation? currentConversation;
    private bool isLoading = false;
    private string loadingMessage = "Thinking...";

    protected override void OnInitialized()
    {
        base.OnInitialized();
        LoadConversation();
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        LoadConversation();
    }

    private void LoadConversation()
    {
        if (!string.IsNullOrEmpty(ConversationId))
        {
            // Load conversation from state
            // TODO: Implement conversation loading from Fluxor state
            currentConversation = new Conversation
            {
                Id = Guid.Parse(ConversationId),
                Title = "Sample Conversation",
                WorkspaceId = Guid.NewGuid(),
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow,
                Messages = new List<Message>()
            };
        }
        else
        {
            // Create new conversation
            currentConversation = null;
        }
    }

    private string GetCurrentUserName()
    {
        // TODO: Get from auth service
        return "John Doe";
    }

    private string GetLoadingText()
    {
        return loadingMessage;
    }

    private List<string> GetExamplePrompts()
    {
        return new List<string>
        {
            "Explain quantum computing in simple terms",
            "Help me debug this Python code",
            "Write a professional email requesting a meeting",
            "Suggest ideas for a weekend project"
        };
    }

    private async Task HandleSendMessage(string content)
    {
        if (string.IsNullOrWhiteSpace(content)) return;

        // Create conversation if it doesn't exist
        if (currentConversation == null)
        {
            currentConversation = new Conversation
            {
                Id = Guid.NewGuid(),
                Title = TruncateToTitle(content),
                WorkspaceId = Guid.NewGuid(), // TODO: Get from current workspace
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow,
                Messages = new List<Message>()
            };

            // Dispatch action to create conversation
            // TODO: Implement Fluxor action
        }

        // Add user message
        var userMessage = new Message
        {
            Id = Guid.NewGuid(),
            ConversationId = currentConversation.Id,
            Role = MessageRole.User,
            Content = content,
            CreatedAt = DateTime.UtcNow
        };

        currentConversation.Messages.Add(userMessage);
        StateHasChanged();

        // TODO: Dispatch AddMessageAction

        // Simulate AI response
        isLoading = true;
        loadingMessage = "Thinking...";
        StateHasChanged();

        try
        {
            // TODO: Call actual AI service
            await Task.Delay(1500); // Simulate API call

            var aiMessage = new Message
            {
                Id = Guid.NewGuid(),
                ConversationId = currentConversation.Id,
                Role = MessageRole.Assistant,
                Content = GenerateSampleResponse(content),
                TokensUsed = 150,
                Cost = 0.0025m,
                CreatedAt = DateTime.UtcNow
            };

            currentConversation.Messages.Add(aiMessage);
            StateHasChanged();

            // TODO: Dispatch AddMessageAction
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleEditMessage((Guid messageId, string content) args)
    {
        var message = currentConversation?.Messages.FirstOrDefault(m => m.Id == args.messageId);
        if (message != null)
        {
            message.Content = args.content;
            message.CreatedAt = DateTime.UtcNow; // Update timestamp

            // TODO: Dispatch UpdateMessageAction
            StateHasChanged();

            // Regenerate response after edit
            await HandleRegenerateMessage(args.messageId);
        }
    }

    private async Task HandleRegenerateMessage(Guid messageId)
    {
        // Find the message and regenerate the AI response
        var messageIndex = currentConversation?.Messages.FindIndex(m => m.Id == messageId) ?? -1;
        if (messageIndex >= 0 && currentConversation != null)
        {
            // Remove all messages after this one
            var messagesToRemove = currentConversation.Messages.Skip(messageIndex + 1).ToList();
            foreach (var msg in messagesToRemove)
            {
                currentConversation.Messages.Remove(msg);
            }

            // Regenerate AI response
            isLoading = true;
            loadingMessage = "Regenerating response...";
            StateHasChanged();

            try
            {
                await Task.Delay(1500); // Simulate API call

                var aiMessage = new Message
                {
                    Id = Guid.NewGuid(),
                    ConversationId = currentConversation.Id,
                    Role = MessageRole.Assistant,
                    Content = GenerateSampleResponse("regenerated"),
                    TokensUsed = 175,
                    Cost = 0.0028m,
                    CreatedAt = DateTime.UtcNow
                };

                currentConversation.Messages.Add(aiMessage);
                StateHasChanged();
            }
            finally
            {
                isLoading = false;
                StateHasChanged();
            }
        }
    }

    private async Task HandleDeleteMessage(Guid messageId)
    {
        if (currentConversation != null)
        {
            var message = currentConversation.Messages.FirstOrDefault(m => m.Id == messageId);
            if (message != null)
            {
                // TODO: Show confirmation dialog
                currentConversation.Messages.Remove(message);
                StateHasChanged();

                // TODO: Dispatch DeleteMessageAction
            }
        }
    }

    private async Task HandleShareMessage(Guid messageId)
    {
        // TODO: Open share dialog
        await Task.CompletedTask;
    }

    private async Task HandleExamplePrompt(string prompt)
    {
        await HandleSendMessage(prompt);
    }

    private string TruncateToTitle(string content, int maxLength = 50)
    {
        if (string.IsNullOrWhiteSpace(content))
            return "New Chat";

        var title = content.Length <= maxLength
            ? content
            : content.Substring(0, maxLength) + "...";

        // Take only first line if multiline
        var firstLine = title.Split('\n')[0];
        return firstLine;
    }

    private string GenerateSampleResponse(string userMessage)
    {
        // Generate a sample markdown response
        return @"# Sample AI Response

I understand you're asking about **" + userMessage.Substring(0, Math.Min(30, userMessage.Length)) + @"**...

Here's a detailed response with various formatting:

## Code Example

```csharp
public class HelloWorld
{
    public static void Main(string[] args)
    {
        Console.WriteLine(""Hello, World!"");
    }
}
```

## Key Points

- **Point 1**: This is an important consideration
- **Point 2**: Another crucial aspect to keep in mind
- **Point 3**: Finally, don't forget this detail

## Inline Code

You can use `var result = Calculate()` for inline code examples.

> **Note**: This is a sample response. In production, this would be replaced with actual AI-generated content.

### Additional Information

For more details, check out the [documentation](https://example.com).

---

Is there anything specific you'd like me to elaborate on?";
    }
}
