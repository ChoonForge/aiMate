@using Fluxor
@using AiMate.Web.Store.Chat
@using AiMate.Web.Store.Project
@inherits Fluxor.Blazor.Web.Components.FluxorComponent
@inject IState<ChatState> ChatState
@inject IState<ProjectState> ProjectState
@inject NavigationManager Navigation

<aside class="w-[280px] bg-[#1A1A1A] border-r border-[#2A2A2A] flex flex-col h-screen">

    @* Logo Header *@
    <div class="p-4 border-b border-[#2A2A2A]">
        <div class="flex items-center gap-2 text-lg font-semibold">
            <svg class="w-6 h-6 text-purple-500" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5zm0 18c-3.87-.96-7-5.38-7-10V8.3l7-3.89 7 3.89V10c0 4.62-3.13 9.04-7 10z"/>
                <path d="M10.9 11.9l-1.4 1.4 4.2 4.2 5.6-5.6-1.4-1.4-4.2 4.2z"/>
            </svg>
            <span class="bg-gradient-to-r from-purple-500 to-blue-500 bg-clip-text text-transparent">
                aiMate
            </span>
        </div>
    </div>

    @* Scrollable Content *@
    <div class="flex-1 overflow-y-auto px-3 py-3">

        @* Start New Chat *@
        <div class="mb-6">
            <a href="/" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-400 hover:bg-[#2A2A2A] hover:text-white transition-all cursor-pointer">
                <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M12 5v14M5 12h14"/>
                </svg>
                <span class="text-sm">Start a new chat</span>
            </a>
        </div>

        @* Quick Actions *@
        <div class="mb-6">
            <a href="/search" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-400 hover:bg-[#2A2A2A] hover:text-white transition-all cursor-pointer mb-1">
                <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
                <span class="text-sm">Search</span>
            </a>

            <a href="/notes" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-400 hover:bg-[#2A2A2A] hover:text-white transition-all cursor-pointer mb-1">
                <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
                <span class="text-sm">Notes</span>
            </a>

            <a href="/knowledge" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-400 hover:bg-[#2A2A2A] hover:text-white transition-all cursor-pointer mb-1">
                <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                </svg>
                <span class="text-sm">Knowledge</span>
            </a>

            <a href="/files" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-400 hover:bg-[#2A2A2A] hover:text-white transition-all cursor-pointer mb-1">
                <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                    <polyline points="13 2 13 9 20 9"/>
                </svg>
                <span class="text-sm">Files</span>
            </a>
        </div>

        @* Projects - Collapsible *@
        <div class="mb-6">
            <div @onclick="ToggleProjects" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-400 hover:bg-[#2A2A2A] hover:text-white transition-all cursor-pointer mb-1">
                <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                </svg>
                <span class="text-sm flex-1">Projects</span>
                <svg class="w-4 h-4 transition-transform @(projectsExpanded ? "rotate-180" : "")"
                     fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <polyline points="6 9 12 15 18 9"/>
                </svg>
            </div>

            @if (projectsExpanded)
            {
                <div class="ml-6 mt-1 space-y-1">
                    <a href="/projects" class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-400 hover:bg-[#2A2A2A] hover:text-white transition-all cursor-pointer text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        <span>New Project</span>
                    </a>

                    @foreach (var project in ProjectState.Value.Projects.Values.Take(5))
                    {
                        <a href="@($"/projects/{project.Id}")" class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-400 hover:bg-[#2A2A2A] hover:text-white transition-all cursor-pointer text-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            </svg>
                            <span>@project.Name</span>
                        </a>
                    }
                </div>
            }
        </div>

        @* Recent Conversations *@
        @if (ChatState.Value.Conversations.Any())
        {
            <div class="mb-6">
                <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 px-3">Recent</div>
                @foreach (var conversation in ChatState.Value.Conversations.Values
                    .Where(c => !c.IsArchived)
                    .OrderByDescending(c => c.UpdatedAt)
                    .Take(10))
                {
                    <a href="@($"/chat/{conversation.Id}")"
                       class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-400 hover:bg-[#2A2A2A] hover:text-white transition-all cursor-pointer mb-1">
                        <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                        <span class="text-sm truncate">@(conversation.Title.Length > 30 ? conversation.Title.Substring(0, 30) + "..." : conversation.Title)</span>
                    </a>
                }
            </div>
        }
    </div>

    @* User Menu at Bottom *@
    <div class="border-t border-[#2A2A2A] p-3">
        <div @onclick="ToggleUserMenu"
             class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-[#2A2A2A] transition-all cursor-pointer relative">
            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-sm font-semibold">
                JD
            </div>
            <div class="flex-1 min-w-0">
                <div class="text-sm font-medium text-white truncate">John Doe</div>
                <div class="text-xs text-gray-400 truncate">john.doe@example.com</div>
            </div>
            <svg class="w-4 h-4 text-gray-400 transition-transform @(userMenuOpen ? "rotate-180" : "")"
                 fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <polyline points="18 15 12 9 6 15"/>
            </svg>
        </div>

        @* User Menu Dropdown *@
        @if (userMenuOpen)
        {
            <div class="absolute bottom-16 left-3 right-3 bg-[#242424] border border-[#2A2A2A] rounded-lg shadow-2xl py-2 z-50">
                <a href="/settings" class="flex items-center gap-3 px-4 py-2.5 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all">
                    <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"/>
                    </svg>
                    Settings
                </a>
                <a href="/archived" class="flex items-center gap-3 px-4 py-2.5 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all">
                    <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <polyline points="21 8 21 21 3 21 3 8"/>
                        <rect x="1" y="3" width="22" height="5"/>
                        <line x1="10" y1="12" x2="14" y2="12"/>
                    </svg>
                    Archived
                </a>
                <a href="/admin" class="flex items-center gap-3 px-4 py-2.5 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all">
                    <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
                    </svg>
                    Admin Panel
                </a>
                <a href="/about" class="flex items-center gap-3 px-4 py-2.5 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all">
                    <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 16v-4m0-4h.01"/>
                    </svg>
                    About
                </a>
                <div class="h-px bg-[#2A2A2A] my-2"></div>
                <a href="/logout" class="flex items-center gap-3 px-4 py-2.5 text-sm text-red-400 hover:bg-[#2A2A2A] hover:text-red-300 transition-all">
                    <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4m7 14l5-5-5-5m5 5H9"/>
                    </svg>
                    Logout
                </a>
            </div>
        }
    </div>
</aside>

@code {
    private bool projectsExpanded = false;
    private bool userMenuOpen = false;

    private void ToggleProjects()
    {
        projectsExpanded = !projectsExpanded;
    }

    private void ToggleUserMenu()
    {
        userMenuOpen = !userMenuOpen;
    }
}
