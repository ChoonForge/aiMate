@using Fluxor
@using AiMate.Web.Store.Auth
@using AiMate.Web.Components.Layout
@inherits Fluxor.Blazor.Web.Components.FluxorComponent
@implements IDisposable
@inject IState<AuthState> AuthState
@inject NavigationManager Navigation

@if (AuthState.Value.IsAuthenticated)
{
    <!-- Main authenticated layout with shell -->
    <div class="layout-container">
        <Sidebar />
        <div class="layout-main">
            <TopBar />
            <main class="layout-content">
                @Body
            </main>
        </div>
    </div>
}
else if (currentPath == "/login")
{
    <!-- Show login page without shell -->
    @Body
}
else
{
    <!-- Redirect if not authenticated and not on login page -->
    <RedirectToLogin />
}

@code {
    [Parameter]
    public RenderFragment? Body { get; set; }

    private string currentPath = "";

    protected override void OnInitialized()
    {
        base.OnInitialized();
        UpdateCurrentPath();
        AuthState.StateChanged += OnAuthStateChanged;
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        UpdateCurrentPath();
    }

    private void UpdateCurrentPath()
    {
        var path = Navigation.Uri.Replace(Navigation.BaseUri, "").Split('?')[0];
        currentPath = string.IsNullOrEmpty(path) ? "/" : "/" + path;
    }

    private void OnAuthStateChanged(object? sender, EventArgs e)
    {
        StateHasChanged();
    }

    public void Dispose()
    {
        AuthState.StateChanged -= OnAuthStateChanged;
    }
}

<style>
    .layout-container {
        display: flex;
        height: 100vh;
        width: 100%;
    }

    .layout-main {
        display: flex;
        flex-direction: column;
        flex: 1;
        overflow: hidden;
    }

    .layout-content {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
    }
</style>
