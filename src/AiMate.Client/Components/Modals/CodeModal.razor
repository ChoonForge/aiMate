@using BlazorMonaco.Editor
@inject AppStateService AppState
@inject ISnackbar Snackbar

<MudDialog @bind-Visible="@IsOpen" Options="@_dialogOptions">
    <DialogContent>
        <MudStack Spacing="2" Style="height: 80vh;">
            @* Toolbar *@
            <MudPaper Class="pa-2" Elevation="0">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.h6">Code Editor</MudText>
                        @if (!string.IsNullOrEmpty(_currentFile))
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Primary">
                                @_currentFile
                            </MudChip>
                        }
                    </MudStack>

                    <MudStack Row="true" Spacing="1">
                        <MudSelect @bind-Value="@_currentLanguage" 
                                  Label="Language" 
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  T="string"
                                  OnValueChanged="@OnLanguageChanged">
                            <MudSelectItem Value="@("csharp")">C#</MudSelectItem>
                            <MudSelectItem Value="@("razor")">Razor</MudSelectItem>
                            <MudSelectItem Value="@("html")">HTML</MudSelectItem>
                            <MudSelectItem Value="@("css")">CSS</MudSelectItem>
                            <MudSelectItem Value="@("javascript")">JavaScript</MudSelectItem>
                            <MudSelectItem Value="@("json")">JSON</MudSelectItem>
                            <MudSelectItem Value="@("xml")">XML</MudSelectItem>
                            <MudSelectItem Value="@("markdown")">Markdown</MudSelectItem>
                        </MudSelect>

                        <MudIconButton Icon="@Icons.Material.Filled.FormatAlignLeft" 
                                      Title="Format Document"
                                      OnClick="@FormatDocument" />
                        
                        <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" 
                                      Title="Copy to Clipboard"
                                      OnClick="@CopyToClipboard" />

                        <MudIconButton Icon="@Icons.Material.Filled.Fullscreen" 
                                      Title="Toggle Fullscreen"
                                      OnClick="@ToggleFullscreen" />
                    </MudStack>
                </MudStack>
            </MudPaper>

            @* File Tabs *@
            @if (_openFiles.Any())
            {
                <MudTabs Elevation="2" Rounded="true" @bind-ActivePanelIndex="@_activeTab">
                    @foreach (var file in _openFiles)
                    {
                        var index = _openFiles.IndexOf(file);
                        <MudTabPanel Text="@file.Name" 
                                    Icon="@GetFileIcon(file.Language)"
                                    @key="file.Path">
                            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.body2">@file.Name</MudText>
                                @if (file.IsDirty)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.Circle" 
                                            Size="Size.Small" 
                                            Color="Color.Warning" 
                                            Title="Unsaved changes" />
                                }
                                <MudIconButton Icon="@Icons.Material.Filled.Close" 
                                              Size="Size.Small"
                                              OnClick="@(() => CloseFile(index))" />
                            </MudStack>
                        </MudTabPanel>
                    }
                </MudTabs>
            }

            @* Monaco Editor *@
            <div class="flex-grow-1">
                <CodeEditor @ref="_codeEditor"
                           Language="@_currentLanguage"
                           Value="@_currentContent"
                           ValueChanged="@OnContentChanged"
                           Height="100%"
                           Theme="@(_isDark ? "vs-dark" : "vs-light")" />
            </div>

            @* Status Bar *@
            <MudPaper Class="pa-2" Elevation="0">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudStack Row="true" Spacing="2">
                        <MudText Typo="Typo.caption">
                            Lines: @_lineCount
                        </MudText>
                        <MudText Typo="Typo.caption">
                            Characters: @_charCount
                        </MudText>
                        @if (_hasErrors)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Error" Icon="@Icons.Material.Filled.Error">
                                @_errorCount errors
                            </MudChip>
                        }
                        @if (_hasWarnings)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning" Icon="@Icons.Material.Filled.Warning">
                                @_warningCount warnings
                            </MudChip>
                        }
                    </MudStack>

                    <MudStack Row="true" Spacing="1">
                        <MudButton Variant="Variant.Outlined"
                                  OnClick="@CompileCode"
                                  StartIcon="@Icons.Material.Filled.Build"
                                  Disabled="@_isCompiling">
                            @(_isCompiling ? "Compiling..." : "Compile")
                        </MudButton>

                        @if (_compilationSuccess)
                        {
                            <MudButton Variant="Variant.Filled"
                                      Color="Color.Success"
                                      OnClick="@ApplyChanges"
                                      StartIcon="@Icons.Material.Filled.Check">
                                Apply Changes
                            </MudButton>
                        }
                    </MudStack>
                </MudStack>
            </MudPaper>
        </MudStack>
    </DialogContent>
</MudDialog>

@code {
    [Parameter]
    public bool IsOpen { get; set; }

    [Parameter]
    public EventCallback<bool> IsOpenChanged { get; set; }

    private DialogOptions _dialogOptions = new DialogOptions
    {
        CloseOnEscapeKey = true,
        MaxWidth = MaxWidth.ExtraExtraLarge,
        FullWidth = true,
        CloseButton = true
    };

    private CodeEditor? _codeEditor;
    private bool _isDark = true;
    private string _currentFile = "Untitled.cs";
    private string _currentLanguage = "csharp";
    private string _currentContent = "// Start coding here...\n\n";
    private List<CodeFile> _openFiles = new();
    private int _activeTab = 0;

    // Status bar
    private int _lineCount = 1;
    private int _charCount = 0;
    private bool _hasErrors = false;
    private bool _hasWarnings = false;
    private int _errorCount = 0;
    private int _warningCount = 0;

    // Compilation
    private bool _isCompiling = false;
    private bool _compilationSuccess = false;

    protected override void OnInitialized()
    {
        // Add initial file
        _openFiles.Add(new CodeFile
        {
            Name = "Untitled.cs",
            Path = "/Untitled.cs",
            Language = "csharp",
            Content = _currentContent
        });
    }

    private void OnContentChanged(string newContent)
    {
        _currentContent = newContent;
        UpdateStats();

        if (_activeTab >= 0 && _activeTab < _openFiles.Count)
        {
            _openFiles[_activeTab].Content = newContent;
            _openFiles[_activeTab].IsDirty = true;
        }
    }

    private void UpdateStats()
    {
        _lineCount = _currentContent.Split('\n').Length;
        _charCount = _currentContent.Length;
    }

    private async Task OnLanguageChanged(string newLanguage)
    {
        _currentLanguage = newLanguage;
        if (_codeEditor != null)
        {
            //await _codeEditor.Lan(newLanguage);
        }
    }

    private async Task FormatDocument()
    {
        if (_codeEditor != null)
        {
            //await _codeEditor.FormatDocumentAsync();
            Snackbar.Add("Document formatted!", Severity.Success);
        }
    }

    private async Task CopyToClipboard()
    {
        if (_codeEditor != null)
        {
            //var content = await _codeEditor.GetValueAsync();
            // Copy to clipboard via JS interop
            Snackbar.Add("Code copied to clipboard!", Severity.Success);
        }
    }

    private void ToggleFullscreen()
    {
        // Toggle fullscreen mode
        //_dialogOptions.MaxWidth = _dialogOptions.MaxWidth == MaxWidth.ExtraExtraLarge 
        //   ? MaxWidth.False 
        //    : MaxWidth.ExtraExtraLarge;
        StateHasChanged();
    }

    private void CloseFile(int index)
    {
        if (_openFiles[index].IsDirty)
        {
            // TODO: Show confirmation dialog
        }
        _openFiles.RemoveAt(index);
        if (_activeTab >= _openFiles.Count)
        {
            _activeTab = Math.Max(0, _openFiles.Count - 1);
        }
    }

    private string GetFileIcon(string language)
    {
        return language switch
        {
            "csharp" => Icons.Material.Filled.Code,
            "razor" => Icons.Material.Filled.Web,
            "html" => Icons.Material.Filled.Html,
            "css" => Icons.Material.Filled.Css,
            "javascript" => Icons.Material.Filled.Javascript,
            "json" => Icons.Material.Filled.DataObject,
            "markdown" => Icons.Material.Filled.Description,
            _ => Icons.Material.Filled.InsertDriveFile
        };
    }

    private async Task CompileCode()
    {
        _isCompiling = true;
        _compilationSuccess = false;
        StateHasChanged();

        try
        {
            // TODO: Call Roslyn compilation service
            await Task.Delay(1000); // Simulate compilation

            // Mock success
            _compilationSuccess = true;
            _hasErrors = false;
            _hasWarnings = false;
            Snackbar.Add("✅ Compilation successful!", Severity.Success);
        }
        catch (Exception ex)
        {
            _hasErrors = true;
            _errorCount = 1;
            Snackbar.Add($"❌ Compilation failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isCompiling = false;
            StateHasChanged();
        }
    }

    private async Task ApplyChanges()
    {
        // TODO: Apply changes to virtual file system
        // TODO: Hot reload if possible
        Snackbar.Add("Changes applied! (Hot reload pending...)", Severity.Info);
        await Close();
    }

    private async Task Close()
    {
        IsOpen = false;
        await IsOpenChanged.InvokeAsync(IsOpen);
    }

    private class CodeFile
    {
        public string Name { get; set; } = string.Empty;
        public string Path { get; set; } = string.Empty;
        public string Language { get; set; } = "csharp";
        public string Content { get; set; } = string.Empty;
        public bool IsDirty { get; set; } = false;
    }
}
