@inject AppStateService AppState
@inject NavigationManager Navigation

<MudDialog @bind-Visible="@IsOpen" Options="@_dialogOptions">
    <DialogContent>
        <MudStack Spacing="3">
            <MudTextField T="string" @bind-Value="@_searchQuery" 
                         Label="Search conversations and messages..." 
                         Variant="Variant.Outlined"
                         Adornment="Adornment.Start"
                         AdornmentIcon="@Icons.Material.Filled.Search"
                         Immediate="true"
                         AutoFocus="true"
                         OnKeyDown="@HandleKeyDown" />

            <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true">
                <MudTabPanel Text="Conversations" Icon="@Icons.Material.Filled.Chat">
                    @if (FilteredConversations.Any())
                    {
                        <MudList T="object" Clickable="true">
                            @foreach (var conv in FilteredConversations.Take(10))
                            {
                                <MudListItem OnClick="@(() => NavigateToConversation(conv.Id))">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.subtitle1">@conv.Title</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @conv.Messages.Count messages • Updated @conv.UpdatedAt.ToString("MMM dd, yyyy")
                                        </MudText>
                                        @if (conv.Messages.Any())
                                        {
                                            var preview = conv.Messages.First().Content;
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                @(preview.Length > 100 ? preview.Substring(0, 97) + "..." : preview)
                                            </MudText>
                                        }
                                    </MudStack>
                                </MudListItem>
                                <MudDivider />
                            }
                        </MudList>

                        @if (FilteredConversations.Count() > 10)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="pa-4">
                                Showing 10 of @FilteredConversations.Count() results
                            </MudText>
                        }
                    }
                    else if (!string.IsNullOrWhiteSpace(_searchQuery))
                    {
                        <MudPaper Class="pa-8" Elevation="0" Style="text-align: center;">
                            <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Secondary" />
                            <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mt-2">
                                No conversations found
                            </MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                Try a different search term
                            </MudText>
                        </MudPaper>
                    }
                    else
                    {
                        <MudPaper Class="pa-8" Elevation="0" Style="text-align: center;">
                            <MudIcon Icon="@Icons.Material.Filled.Search" Size="Size.Large" Color="Color.Secondary" />
                            <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mt-2">
                                Start typing to search conversations
                            </MudText>
                        </MudPaper>
                    }
                </MudTabPanel>

                <MudTabPanel Text="Messages" Icon="@Icons.Material.Filled.Message">
                    @if (FilteredMessages.Any())
                    {
                        <MudList T="object" Clickable="true">
                            @foreach (var result in FilteredMessages.Take(20))
                            {
                                <MudListItem OnClick="@(() => NavigateToMessage(result.ConversationId, result.Message.Id))">
                                    <MudStack Spacing="1">
                                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                            <MudText Typo="Typo.subtitle2">@result.ConversationTitle</MudText>
                                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">
                                                @result.Message.Role
                                            </MudChip>
                                        </MudStack>
                                        <MudText Typo="Typo.body2">
                                            @HighlightSearchTerm(result.Message.Content)
                                        </MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @result.Message.Timestamp.ToString("MMM dd, yyyy HH:mm")
                                        </MudText>
                                    </MudStack>
                                </MudListItem>
                                <MudDivider />
                            }
                        </MudList>

                        @if (FilteredMessages.Count() > 20)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="pa-4">
                                Showing 20 of @FilteredMessages.Count() results
                            </MudText>
                        }
                    }
                    else if (!string.IsNullOrWhiteSpace(_searchQuery))
                    {
                        <MudPaper Class="pa-8" Elevation="0" Style="text-align: center;">
                            <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Secondary" />
                            <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mt-2">
                                No messages found
                            </MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                Try a different search term
                            </MudText>
                        </MudPaper>
                    }
                    else
                    {
                        <MudPaper Class="pa-8" Elevation="0" Style="text-align: center;">
                            <MudIcon Icon="@Icons.Material.Filled.Search" Size="Size.Large" Color="Color.Secondary" />
                            <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mt-2">
                                Start typing to search messages
                            </MudText>
                        </MudPaper>
                    }
                </MudTabPanel>
            </MudTabs>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@Close">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter]
    public bool IsOpen { get; set; }

    [Parameter]
    public EventCallback<bool> IsOpenChanged { get; set; }

    private DialogOptions _dialogOptions = new DialogOptions
    {
        CloseOnEscapeKey = true,
        MaxWidth = MaxWidth.Large,
        FullWidth = true
    };

    private string _searchQuery = string.Empty;

    private IEnumerable<Conversation> FilteredConversations
    {
        get
        {
            if (string.IsNullOrWhiteSpace(_searchQuery))
                return Enumerable.Empty<Conversation>();

            var query = _searchQuery.ToLower();
            return AppState.Conversations
                .Where(c => !c.IsArchived)
                .Where(c =>
                    c.Title.ToLower().Contains(query) ||
                    c.Messages.Any(m => m.Content.ToLower().Contains(query))
                )
                .OrderByDescending(c => c.UpdatedAt);
        }
    }

    private IEnumerable<MessageSearchResult> FilteredMessages
    {
        get
        {
            if (string.IsNullOrWhiteSpace(_searchQuery))
                return Enumerable.Empty<MessageSearchResult>();

            var query = _searchQuery.ToLower();
            var results = new List<MessageSearchResult>();

            foreach (var conv in AppState.Conversations.Where(c => !c.IsArchived))
            {
                var matchingMessages = conv.Messages
                    .Where(m => m.Content.ToLower().Contains(query))
                    .Select(m => new MessageSearchResult
                    {
                        ConversationId = conv.Id,
                        ConversationTitle = conv.Title,
                        Message = m
                    });

                results.AddRange(matchingMessages);
            }

            return results.OrderByDescending(r => r.Message.Timestamp);
        }
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            Close();
        }
    }

    private async Task NavigateToConversation(string conversationId)
    {
        AppState.SetActiveConversation(conversationId);
        Navigation.NavigateTo($"/chat/{conversationId}");
        await Close();
    }

    private async Task NavigateToMessage(string conversationId, string messageId)
    {
        AppState.SetActiveConversation(conversationId);
        Navigation.NavigateTo($"/chat/{conversationId}#{messageId}");
        await Close();
    }

    private string HighlightSearchTerm(string content)
    {
        if (string.IsNullOrWhiteSpace(_searchQuery))
            return content.Length > 200 ? content.Substring(0, 197) + "..." : content;

        // Find the search term in the content
        var query = _searchQuery.ToLower();
        var index = content.ToLower().IndexOf(query);

        if (index == -1)
            return content.Length > 200 ? content.Substring(0, 197) + "..." : content;

        // Get a snippet around the match
        var start = Math.Max(0, index - 50);
        var length = Math.Min(200, content.Length - start);
        var snippet = content.Substring(start, length);

        if (start > 0) snippet = "..." + snippet;
        if (start + length < content.Length) snippet += "...";

        return snippet;
    }

    private async Task Close()
    {
        IsOpen = false;
        await IsOpenChanged.InvokeAsync(IsOpen);
    }

    private class MessageSearchResult
    {
        public string ConversationId { get; set; } = string.Empty;
        public string ConversationTitle { get; set; } = string.Empty;
        public Message Message { get; set; } = null!;
    }
}
